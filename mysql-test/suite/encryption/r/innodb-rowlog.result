SET GLOBAL innodb_file_format = `Barracuda`;
create table t1(id int not null primary key auto_increment, credit_card varchar(200), private varchar(50)) engine=innodb;
SET SESSION debug_dbug="+d,ib_merge_wait_after_read";
alter table t1 add index secret (credit_card), ALGORITHM=INPLACE, LOCK=NONE;
SET GLOBAL innodb_encryption_rotate_key_age = 1;
create table t2(id int) engine=innodb;
SET SESSION debug_dbug="+d,ib_merge_wait_after_read";
alter table t1 add index secret2 (private), ALGORITHM=INPLACE, LOCK=NONE;
insert into t1(credit_card) select credit_card from t1;
insert into t1(credit_card) select credit_card from t1;
insert into t1(credit_card) select credit_card from t1;
drop table t2;
SELECT variable_value > 0 FROM information_schema.global_status WHERE variable_name = 'innodb_num_pages_encrypted';
variable_value > 0
1
SELECT variable_value > 0 FROM information_schema.global_status WHERE variable_name = 'innodb_encryption_n_merge_blocks_encrypted';
variable_value > 0
1
SELECT variable_value > 0 FROM information_schema.global_status WHERE variable_name = 'innodb_encryption_n_merge_blocks_decrypted';
variable_value > 0
1
SELECT variable_value > 0 FROM information_schema.global_status WHERE variable_name = 'innodb_encryption_n_rowlog_blocks_encrypted';
variable_value > 0
1
SELECT variable_value > 0 FROM information_schema.global_status WHERE variable_name = 'innodb_encryption_n_rowlog_blocks_decrypted';
variable_value > 0
1
drop table t1;
SET GLOBAL innodb_file_format=Antelope;
SET GLOBAL innodb_encryption_rotate_key_age=15;
